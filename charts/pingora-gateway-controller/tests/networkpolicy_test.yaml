suite: test networkpolicy template
templates:
  - templates/networkpolicy.yaml
tests:
  - it: should create NetworkPolicy when enabled
    set:
      networkPolicy.enabled: true
    asserts:
      - hasDocuments:
          count: 1
      - isKind:
          of: NetworkPolicy
      - equal:
          path: apiVersion
          value: networking.k8s.io/v1

  - it: should not create NetworkPolicy when disabled
    set:
      networkPolicy.enabled: false
    asserts:
      - hasDocuments:
          count: 0

  - it: should have Ingress and Egress policy types
    set:
      networkPolicy.enabled: true
    asserts:
      - contains:
          path: spec.policyTypes
          content: Ingress
      - contains:
          path: spec.policyTypes
          content: Egress

  - it: should allow ingress on metrics and health ports
    set:
      networkPolicy.enabled: true
      service.metricsPort: 8080
      service.healthPort: 8081
    asserts:
      - contains:
          path: spec.ingress[0].ports
          content:
            protocol: TCP
            port: 8080
      - contains:
          path: spec.ingress[0].ports
          content:
            protocol: TCP
            port: 8081

  - it: should allow DNS egress
    set:
      networkPolicy.enabled: true
    asserts:
      - contains:
          path: spec.egress[0].ports
          content:
            protocol: UDP
            port: 53
      - contains:
          path: spec.egress[0].ports
          content:
            protocol: TCP
            port: 53

  - it: should allow Kubernetes API egress
    set:
      networkPolicy.enabled: true
    asserts:
      - contains:
          path: spec.egress[1].ports
          content:
            protocol: TCP
            port: 443
      - contains:
          path: spec.egress[1].ports
          content:
            protocol: TCP
            port: 6443

  - it: should allow egress to proxy gRPC port
    set:
      networkPolicy.enabled: true
      networkPolicy.pingoraProxy.port: 50051
    asserts:
      - contains:
          path: spec.egress[2].ports
          content:
            protocol: TCP
            port: 50051

  - it: should use custom proxy port when specified
    set:
      networkPolicy.enabled: true
      networkPolicy.pingoraProxy.port: 9999
    asserts:
      - contains:
          path: spec.egress[2].ports
          content:
            protocol: TCP
            port: 9999

  - it: should select controller pods
    release:
      name: test
    set:
      networkPolicy.enabled: true
    asserts:
      - equal:
          path: spec.podSelector.matchLabels["app.kubernetes.io/name"]
          value: pingora-gateway-controller
      - equal:
          path: spec.podSelector.matchLabels["app.kubernetes.io/instance"]
          value: test

  - it: should have standard labels
    set:
      networkPolicy.enabled: true
    asserts:
      - isNotNull:
          path: metadata.labels
      - equal:
          path: metadata.labels["app.kubernetes.io/name"]
          value: pingora-gateway-controller
