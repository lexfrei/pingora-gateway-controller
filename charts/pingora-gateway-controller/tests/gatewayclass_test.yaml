suite: test gatewayclass template
templates:
  - templates/gatewayclass.yaml
tests:
  - it: should create GatewayClass when enabled
    set:
      gatewayClass.create: true
    asserts:
      - hasDocuments:
          count: 1
      - isKind:
          of: GatewayClass
      - equal:
          path: apiVersion
          value: gateway.networking.k8s.io/v1

  - it: should set correct controller name
    set:
      gatewayClass.create: true
      controller.controllerName: pingora.k8s.lex.la/gateway-controller
      controller.gatewayClassName: pingora
    asserts:
      - equal:
          path: spec.controllerName
          value: pingora.k8s.lex.la/gateway-controller
      - equal:
          path: metadata.name
          value: pingora

  - it: should reference PingoraConfig when pingoraConfig.create is true
    set:
      gatewayClass.create: true
      pingoraConfig.create: true
    asserts:
      - equal:
          path: spec.parametersRef.group
          value: pingora.k8s.lex.la
      - equal:
          path: spec.parametersRef.kind
          value: PingoraConfig
      - isNotNull:
          path: spec.parametersRef.name

  - it: should NOT have parametersRef when pingoraConfig.create is false
    set:
      gatewayClass.create: true
      pingoraConfig.create: false
    asserts:
      - isNull:
          path: spec.parametersRef

  - it: should not create GatewayClass when disabled
    set:
      gatewayClass.create: false
    asserts:
      - hasDocuments:
          count: 0

  - it: should use custom pingoraConfig name when specified
    release:
      name: my-release
    set:
      gatewayClass.create: true
      pingoraConfig.create: true
      pingoraConfig.name: custom-config
    asserts:
      - equal:
          path: spec.parametersRef.name
          value: custom-config

  - it: should use fullname for pingoraConfig when name not specified
    release:
      name: test-release
    set:
      gatewayClass.create: true
      pingoraConfig.create: true
      pingoraConfig.name: ""
    asserts:
      - matchRegex:
          path: spec.parametersRef.name
          pattern: ^test-release
